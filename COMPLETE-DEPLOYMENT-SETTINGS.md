# Complete Deployment Settings for Arman Law Firm

## Project Overview

- **Project Type:** Full-stack React + Express application
- **Frontend:** React + Vite (static files)
- **Backend:** Express.js server with PostgreSQL
- **AI Integration:** Google Gemini API

---

## CLOUDFLARE PAGES SETTINGS (Frontend)

### Build Configuration

| Setting | Value |
|---------|-------|
| **Framework preset** | None |
| **Build command** | `npm run build` |
| **Build output directory** | `dist` |
| **Root directory** | `/` (leave empty or use `/`) |
| **Deploy command** | **LEAVE EMPTY** (do not set!) |
| **Node.js version** | 20 |

### Why Deploy Command Must Be Empty

- This is a **Pages project**, NOT a Workers project
- Cloudflare Pages with Git integration auto-deploys from Git
- `npx wrangler deploy` = Workers only (causes error)
- `npx wrangler pages deploy` = CLI only (needs API permissions)
- **Solution:** Leave deploy command empty, Cloudflare handles it automatically

### Environment Variables (Cloudflare Dashboard)

| Variable Name | Value | Type |
|---------------|-------|------|
| `NODE_VERSION` | `20` | Plaintext |
| `VITE_API_URL` | `https://armanlawfirm-api.onrender.com/` | Plaintext |
| `VITE_GEMINI_API_KEY` | Your Google AI API key | **Secret** |
| `VITE_API_KEY` | Your API key | **Secret** |
| `SUPABASE_URL` | `https://vemzvvveaseghlhjmnqy.supabase.co` | Plaintext |
| `SUPABASE_ANON_KEY` | Your Supabase anon key | **Secret** |
| `API_KEY` | Your API key | **Secret** |

### Files Used by Cloudflare

| File | Purpose |
|------|---------|
| `wrangler.toml` | Configuration (optional, for reference) |
| `dist/` | Built static files (generated by npm run build) |
| `functions/` | Serverless API functions (optional) |
| `index.html` | Entry point |
| `vite.config.ts` | Vite build configuration |

### Cloudflare Pages URLs

| URL | Description |
|-----|-------------|
| `https://armanlawfirmr-based-of-adl-pendar-based-of-3.pages.dev` | Main website |
| Custom domain: `armanlawfirm.ir` | Your domain (configure in Custom Domains) |

---

## RENDER.COM SETTINGS (Backend API)

### Service Configuration

| Setting | Value |
|---------|-------|
| **Service type** | Web Service |
| **Name** | `armanlawfirm-api` |
| **Environment** | Node |
| **Region** | Oregon (or closest to users) |
| **Plan** | Free |
| **Build command** | `npm install && npm run build` |
| **Start command** | `npm start` |
| **Health check path** | `/api/health` |

### Environment Variables (Render Dashboard)

| Variable Name | Value | Required |
|---------------|-------|----------|
| `NODE_ENV` | `production` | Yes |
| `NODE_VERSION` | `20` | Yes |
| `GEMINI_API_KEY` | Your Google AI API key | Yes |
| `DATABASE_URL` | PostgreSQL connection string | Yes |
| `SESSION_SECRET` | Random 32+ character string | Yes |
| `PORT` | `3001` (or auto-assigned) | Optional |

### Files Used by Render

| File | Purpose |
|------|---------|
| `render.yaml` | Blueprint configuration (auto-detected) |
| `server/` | Express server code |
| `server/index.ts` | Server entry point |
| `server/routes.ts` | API routes |
| `server/storage.ts` | Database operations |
| `package.json` | Dependencies and scripts |

### Render API URLs

| URL | Description |
|-----|-------------|
| `https://armanlawfirm-api.onrender.com` | Backend API base URL |
| `https://armanlawfirm-api.onrender.com/api/health` | Health check |
| `https://armanlawfirm-api.onrender.com/api/generate` | AI generation endpoint |

---

## COMPLETE ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRODUCTION ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   USER BROWSER                                                               │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     CLOUDFLARE PAGES (Frontend)                      │    │
│  │                                                                       │    │
│  │  URL: armanlawfirm.pages.dev (or armanlawfirm.ir)                    │    │
│  │                                                                       │    │
│  │  Serves:                                                              │    │
│  │  - React application (dist/)                                          │    │
│  │  - Static assets (CSS, JS, images)                                    │    │
│  │  - index.html                                                         │    │
│  │                                                                       │    │
│  │  Build: npm run build                                                 │    │
│  │  Deploy: Automatic from Git (no command needed)                       │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        │ API calls to VITE_API_URL                                          │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      RENDER.COM (Backend API)                         │    │
│  │                                                                       │    │
│  │  URL: armanlawfirm-api.onrender.com                                  │    │
│  │                                                                       │    │
│  │  Handles:                                                             │    │
│  │  - /api/generate (AI text generation)                                 │    │
│  │  - /api/health (health checks)                                        │    │
│  │  - /api/auth/* (user authentication)                                  │    │
│  │  - /api/contracts/* (contract management)                             │    │
│  │  - Database operations                                                │    │
│  │                                                                       │    │
│  │  Start: npm start (runs tsx server/index.ts)                          │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    POSTGRESQL DATABASE (Neon/Supabase)                │    │
│  │                                                                       │    │
│  │  Connection: DATABASE_URL environment variable                        │    │
│  │  ORM: Drizzle ORM                                                     │    │
│  │                                                                       │    │
│  │  Tables:                                                              │    │
│  │  - users (user accounts)                                              │    │
│  │  - sessions (login sessions)                                          │    │
│  │  - contracts (saved contracts)                                        │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      GOOGLE GEMINI AI API                             │    │
│  │                                                                       │    │
│  │  API Key: GEMINI_API_KEY                                              │    │
│  │  Model: gemini-2.0-flash                                              │    │
│  │  Used for: Legal text generation, contract analysis                   │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## COMMON ERRORS AND SOLUTIONS

### Error 1: "Workers-specific command in a Pages project"

**Cause:** Deploy command set to `npx wrangler deploy`
**Solution:** Remove/clear the deploy command entirely

### Error 2: "Authentication error [code: 10000]"

**Cause:** Using `npx wrangler pages deploy` with Git integration
**Solution:** Remove deploy command - Git integration handles deployment

### Error 3: API returns 404 or CORS error

**Cause:** Frontend calling wrong API URL
**Solution:** Set `VITE_API_URL` to Render backend URL

### Error 4: Build fails on Cloudflare

**Cause:** Missing dependencies or build errors
**Solution:** Run `npm run build` locally first to test

### Error 5: Render backend not starting

**Cause:** Missing environment variables
**Solution:** Ensure DATABASE_URL and GEMINI_API_KEY are set

---

## DEPLOYMENT CHECKLIST

### Before Deploying

- [ ] Run `npm run build` locally - should complete without errors
- [ ] All secrets/API keys ready
- [ ] GitHub repository is up to date

### Cloudflare Pages Setup

- [ ] Connect GitHub repository
- [ ] Set build command: `npm run build`
- [ ] Set build output: `dist`
- [ ] **Leave deploy command EMPTY**
- [ ] Add all environment variables
- [ ] Click Save and Deploy

### Render Setup

- [ ] Create new Web Service
- [ ] Connect GitHub repository
- [ ] Set build command: `npm install && npm run build`
- [ ] Set start command: `npm start`
- [ ] Add all environment variables (DATABASE_URL, GEMINI_API_KEY, SESSION_SECRET)
- [ ] Deploy

### After Deployment

- [ ] Test frontend loads at Cloudflare URL
- [ ] Test API health: `https://armanlawfirm-api.onrender.com/api/health`
- [ ] Test AI generation works
- [ ] Configure custom domain if needed

---

## PACKAGE.JSON SCRIPTS

```json
{
  "scripts": {
    "dev": "tsx server/index.ts & vite",
    "server": "tsx server/index.ts",
    "build": "vite build",
    "start": "tsx server/index.ts",
    "preview": "vite preview"
  }
}
```

| Script | Purpose | Used By |
|--------|---------|---------|
| `npm run dev` | Development (frontend + backend) | Local development |
| `npm run build` | Build frontend to dist/ | Cloudflare & Render |
| `npm start` | Start backend server | Render production |
| `npm run server` | Start backend only | Local testing |

---

## KEY FILES SUMMARY

| File | Platform | Description |
|------|----------|-------------|
| `wrangler.toml` | Cloudflare | Pages configuration (optional) |
| `render.yaml` | Render | Blueprint configuration |
| `vite.config.ts` | Both | Vite build settings |
| `package.json` | Both | Dependencies and scripts |
| `server/index.ts` | Render | Express server entry |
| `functions/` | Cloudflare | Serverless functions (optional) |
| `dist/` | Cloudflare | Built frontend files |

---

## CONTACT & SUPPORT

- Cloudflare Pages Docs: https://developers.cloudflare.com/pages
- Render Docs: https://render.com/docs
- Google AI Docs: https://ai.google.dev/docs
